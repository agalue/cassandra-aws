# @author agalue@opennms.com
---
- name: 'Decommission Cassandra instance {{ item.key }} ({{ item.value }}); be patient, his can take a long time'
  shell: 'nodetool -u cassandra -pw cassandra -h {{ item.value }} decommission > /tmp/decommission.finished'
  args:
    creates: /tmp/decommission.finished

- name: 'Stop Cassandra instance {{ item.key }}'
  systemd:
    name: 'cassandra3@{{ item.key }}'
    state: stopped
 
- name: 'Generate cassandra-rackdc.properties for {{ item.key }}'
  template:
    src: cassandra-rackdc.j2
    dest: '/etc/cassandra/{{ item.key }}/cassandra-rackdc.properties'
    mode: 0644
    owner: cassandra
    group: cassandra

- name: 'Remove /var/lib/cassandra for {{ item.key }}'
  file:
    state: absent
    path: '/var/lib/cassandra/{{ item.key }}'

- name: 'Initialize /var/lib/cassandra for {{ item.key }}'
  file:
    state: directory
    mode: 0755
    owner: cassandra
    group: cassandra
    path: '/var/lib/cassandra/{{ item.key }}'

- name: 'Initialize /var/lib/cassandra/commitlog for {{ item.key }}'
  file:
    path: '/var/lib/cassandra/{{ item.key }}/commitlog'
    mode: 0755
    state: directory
    owner: cassandra
    group: cassandra

- name: 'Initialize /var/lib/cassandra/data for {{ item.key }}'
  file:
    path: '/var/lib/cassandra/{{ item.key }}/data'
    mode: 0755
    state: directory
    owner: cassandra
    group: cassandra

- name: 'Initialize /var/lib/cassandra/hints for {{ item.key }}'
  file:
    path: '/var/lib/cassandra/{{ item.key }}/hints'
    mode: 0755
    state: directory
    owner: cassandra
    group: cassandra

- name: 'Initialize /var/lib/cassandra/saved_caches for {{ item.key }}'
  file:
    path: '/var/lib/cassandra/{{ item.key }}/saved_caches'
    mode: 0755
    state: directory
    owner: cassandra
    group: cassandra

- name: 'Start Cassandra instance {{ item.key }} (joining the cluster as a new node)'
  service:
    name: 'cassandra3@{{ item.key }}'
    state: started

- name: 'Wait for {{ item.key }} ({{ item.value }}) to join the cluster; be patient, his can take a long time'
  shell: 'set -o pipefail && nodetool -u cassandra -pw cassandra status 2>/dev/null | grep {{ item.value }}'
  changed_when: False
  register: result
  until: result.stdout is regex("^UN.*")
  delay: 300
  retries: 4032 # 300 * 4032 ~ 2 weeks
