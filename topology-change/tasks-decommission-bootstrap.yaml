# @author agalue@opennms.com
---
- name: 'Decomission Cassandra instance {{ item.key }}'
  command: 'nodetool -u cassandra -pw cassandra -h {{ item.value }} decomission'

- name: 'Stop Cassandra instance {{ item.key }}'
  systemd:
    name: 'cassandra3@{{ item.key }}'
    state: stopped
 
- name: 'Generate cassandra-rackdc.properties for {{ item.key }}'
  template:
    src: cassandra-rackdc.j2
    dest: '/etc/cassandra/{{ item.key }}/cassandra-rackdc.properties'

- name: 'Remove /var/lib/cassandra for {{ item.key }}'
  file:
    state: absent
    path: '/var/lib/cassandra/{{ item.key }}'

- name: 'Initialize /var/lib/cassandra for {{ item.key }}'
  file:
    state: directory
    owner: cassandra
    group: cassandra
    path: '/var/lib/cassandra/{{ item.key }}'

- name: 'Initialize /var/lib/cassandra/commitlog for {{ item.key }}'
  file:
    path: '/var/lib/cassandra/{{ item.key }}/commitlog'
    state: directory
    owner: cassandra
    group: cassandra

- name: 'Initialize /var/lib/cassandra/data for {{ item.key }}'
  file:
    path: '/var/lib/cassandra/{{ item.key }}/data'
    state: directory
    owner: cassandra
    group: cassandra

- name: 'Initialize /var/lib/cassandra/hints for {{ item.key }}'
  file:
    path: '/var/lib/cassandra/{{ item.key }}/hints'
    state: directory
    owner: cassandra
    group: cassandra

- name: 'Initialize /var/lib/cassandra/saved_caches for {{ item.key }}'
  file:
    path: '/var/lib/cassandra/{{ item.key }}/saved_caches'
    state: directory
    owner: cassandra
    group: cassandra

- name: 'Start Cassandra instance {{ item.key }}'
  service:
    name: 'cassandra3@{{ item.key }}'
    state: started

- name: 'Wait for {{ item.value }} to join the cluster'
  shell: 'nodetool -u cassandra -pw cassandra status 2>/dev/null | grep {{ item.value }}'
  changed_when: False
  register: result
  until: result.stdout is regex("^UN.*")
  delay: 300
  retries: 4032 # 300 * 4032 ~ 2 weeks
